<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audio Recorder</title>
  </head>
  <body>
    <button id="startButton" onclick="startRecording()" style="display: inline">Старт</button>
    <button id="stopButton" onclick="stopRecording()" disabled style="display: none">Стоп</button>
    <audio id="audioPlayer" controls style="display: none"></audio>
    <div id="transcriptionResult"></div>
    <p id="recordingIndicator" style="display: none">Записываем...</p>

    <script>
      let recorder;
      let audioChunks = [];

      function startRecording() {
        audioChunks = [];
        navigator.mediaDevices
          .getUserMedia({ audio: true })
          .then((stream) => {
            recorder = new MediaRecorder(stream);

            recorder.ondataavailable = (e) => {
              if (e.data.size > 0) {
                audioChunks.push(e.data);
              }
            };

            recorder.start();
            document.getElementById('startButton').style.display = 'none';
            document.getElementById('stopButton').style.display = 'inline';
            document.getElementById('recordingIndicator').style.display = 'inline';
            document.getElementById('stopButton').disabled = false;
          })
          .catch((error) => {
            console.error('Ошибка доступа к микрофону:', error);
          });
      }

      function stopRecording() {
        recorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          const audioUrl = URL.createObjectURL(audioBlob);

          document.getElementById('audioPlayer').src = audioUrl;
          document.getElementById('audioPlayer').style.display = 'block';

          const formData = new FormData();
          formData.append('audio', audioBlob, 'audio.wav');

          fetch('/transcribe', {
            method: 'POST',
            body: formData,
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error('Ошибка распознования аудио.');
              }
              return response.json();
            })
            .then((data) => {
              document.getElementById('transcriptionResult').innerText = 'Текст: ' + data.transcription;
            })
            .catch((error) => {
              document.getElementById('transcriptionResult').innerText = 'Ошибка: ' + error.message;
            })
            .finally(() => {
              document.getElementById('stopButton').style.display = 'none';
              document.getElementById('startButton').style.display = 'inline';
              document.getElementById('recordingIndicator').style.display = 'none';
              document.getElementById('stopButton').disabled = true;
            });
        };

        recorder.stop();
      }
    </script>
  </body>
</html>